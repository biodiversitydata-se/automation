#! /bin/bash
#
# Perform rsync of target snapshot on this node to backup source
# ==============================================================
#
# 
# usage:
#   restore_backup_snapshot <options> 
#
#   where 
#         <options> = [-v] [-t]
#             
#   -v    : verbose output - default false
#   -t    : dry run and only output info  - default false




# Read arguments and switches
verbose=''
dry_run=''


while true 
do
    case $1 in

	-v) verbose="-v"
	    shift
	    ;;
	-t) dry_run="-t"
	    shift
	    ;;
	*) break	    
	    ;;
    esac
done


rsync_flags=""

bin_dir=$(dirname $0)
lib_dir=/opt/sbdi/lib  

. $lib_dir/log_utils

log_logging_application="BACKUP"

[ $EUID -eq 0 ] || log_fatal  88 "Root privileges reqiured" 

result=0

{% for source_host in groups['backup_sources'] %}

backup_name={{ source_host }}

remote_dest={{deployment_prefix}}-{{ source_host }}

if /usr/bin/rsync -a -e /usr/bin/ssh --rsync-path="/usr/bin/sudo /usr/bin/rsync" \
      $dry_run $verbose $rsync_flags  \
      /backup/snapshot/$backup_name/ --delete-after backupoperator@$remote_dest:/docker
then
    log_info "Performed rsync /backup/snapshot/$backup_name/ -> backupoperator@$remote_dest:/docker"
else
    error=$?
    log_error $error "Failed to rsync /backup/snapshot/$backup_name/ -> backupoperator@$remote_dest:/docker - error: $error"
    result=91
fi

{% endfor %}

exit result

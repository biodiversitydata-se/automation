#! /bin/bash

bin_dir=$(dirname $0)
lib_dir=/opt/sbdi/lib  #${SOMO_LIBDIR:-$bin_dir/../lib}

. $lib_dir/log_utils

log_logging_application="BACKUP"

[ $EUID -eq 0 ] && log_warn "Do *not* run as root"

eval `ssh-agent -s`
ssh-add .ssh/id_rsa

{% for host in groups['docker'] | union(groups['docker_swarm']) %}

log_info "Stopping docker on {{ host }}"

if ssh backupoperator@{{deployment_prefix}}-{{ host }} 'sudo /opt/sbdi/backup/bin/stop_docker'
then
    log_info "Successfully stopped docker on {{ host }}"
else
    error_code=$?
    log_error "Failed to stop docker on {{ host }} - error: ${error_code}"
fi

{% endfor %}

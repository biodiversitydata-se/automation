--- 
- name: Install and configure servers and gatways 
  hosts: servers:gateways
  become: true
  tasks:
  - name: Add docker repo key
    ansible.builtin.apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present    
  - name: Add docker repo
    ansible.builtin.apt_repository:
      repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable"
      state: present
  - name: Update and upgrade apt packages
    apt:
      upgrade: dist
      update_cache: yes
      cache_valid_time: 86400 #One day
  - name: Reboot the machine
    reboot: 
  - name: Install basic packages
    apt:
      pkg:
      - net-tools
      - ca-certificates
      - software-properties-common
      - docker-ce
  - name: Download and install docker compose
    get_url:
      url: "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-Linux-x86_64"
      timeout: 30
      dest: /usr/local/bin/docker-compose
      owner: root
      mode: 755
      
- name: Install utility scripts, auotupdates and nrpe client
  hosts: servers:gateways
  become: true
  roles:
    - role: sbdi_utility_scripts
    - role: autoupdate
      tags:
        - autoupdate
        - nrpeclient      